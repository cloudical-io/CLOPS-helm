image: docker.io/alpine/k8s:1.26.6

stages:
  - prepare
  - update_check
  - test
  - release
  - push

# Define Global Definitions
.defaults:
  cache: &global_cache
    policy: push
    unprotect: false
    untracked: true
    when: on_success
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - Chart.lock
      - charts/

# Prepare Docker access
.kaniko:
  before_script:
    - echo "{\"auths\":{\"${CI_CONTAINER_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${REGISTRY_USER}" "${REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json

build dependency:
  stage: prepare
  cache:
    <<: *global_cache
  script:
    - helm dependency update

scanner image:
  stage: prepare
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  extends: .kaniko
  only:
    changes:
      - docker/Dockerfile
    refs:
      - main
  script: |
    /kaniko/executor \
      --context $CI_PROJECT_DIR/docker \
      --dockerfile $CI_PROJECT_DIR/docker/Dockerfile \
      --destination "$CI_CONTAINER_REGISTRY/$CI_REGISTRY_PROJECT/datree-scanner:latest"

yaml diff image:
  stage: prepare
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  extends: .kaniko
  only:
    changes:
      - docker/Dockerfile-k8s
    refs:
      - main
  script: |
    /kaniko/executor \
      --context $CI_PROJECT_DIR \
      --dockerfile $CI_PROJECT_DIR/docker/Dockerfile-k8s \
      --destination "$CI_CONTAINER_REGISTRY/$CI_REGISTRY_PROJECT/diff-image:latest"

check chart for updates:
  stage: update_check
  image: "$CI_CONTAINER_REGISTRY/$CI_REGISTRY_PROJECT/diff-image:latest"
  allow_failure: true
  script:
    - sh -c /apps/getChartVersions.sh

chart scan:
  image: $CI_CONTAINER_REGISTRY/$CI_REGISTRY_PROJECT/datree-scanner:latest
  stage: test
  cache:
    <<: *global_cache
    policy: pull
  script:
    - helm template clops -f values.yaml . > rendered.yaml
    - datree test --no-record --ignore-missing-schemas --schema-version 1.27.3 ./rendered.yaml || true

template dump:
  stage: test
  cache:
    <<: *global_cache
    policy: pull
  script:
    - helm template clops -f values.yaml .

release:
  image: $CI_CONTAINER_REGISTRY/cci-tools/semantic-release@sha256:3c237539f069b3ed5a863f9d02682ca5844a4c5cb3c1e2629043c33c56b93c6d
  stage: release
  script:
    - semantic-release
  only:
    refs:
      - main
      - dev
  except:
    changes:
      - "CHANGELOG.md"

build chart:
  stage: push
  only:
    refs:
      - tags
  except:
    refs:
      - branches
  script:
    - helm dependency update
    - helm package .
  artifacts:
    untracked: false
    when: on_success
    expire_in: "30 days"
    paths:
      - "clops-helm-*.tgz"

push chart:
  stage: push
  needs:
    - "build chart"
  only:
    refs:
      - tags
  except:
    refs:
      - branches
  script:
    ## Not needed since already present in container
    #- helm plugin install https://github.com/chartmuseum/helm-push
    - |
      sed -i "s/^version:.*$/version: $CI_COMMIT_TAG/g" Chart.yaml
    - helm repo add cloudical-clops "https://$CI_CHART_REGISTRY/$CI_REGISTRY_PROJECT"
    - helm cm-push --dependency-update clops-helm-*.tgz cloudical-clops
