image: docker.io/alpine/k8s:1.26.3

stages:
  - test
  - build
  - push

template_test:
  stage: test
  script:
    - |
      pip3 install --upgrade pip && pip3 install --upgrade setuptools && \
      pip3 install checkov
    - helm template clops -f values.yaml . > rendered.yaml
    - checkov -f rendered.yaml --framework kubernetes --no-guide

chart_scan:
  stage: test
  script:
    - helm template clops -f values.yaml .

build_chart:
  stage: build
  script:
    - helm dependency build
    - helm package .
  artifacts:
    untracked: false
    when: on_success
    expire_in: "30 days"
    paths:
      - "CLOPS-helm-*.tgz"

push_chart:
  stage: push
  only:
    refs:
      - main
  script:
    - helm plugin install https://github.com/chartmuseum/helm-push
    - helm cm-push --dependency-update CLOPS-helm-*.tgz vanillastack-harbor-cloudical-net
